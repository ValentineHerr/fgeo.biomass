---
title: "Plot dbh vs. biomass by species"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(1)
```

```{r}
# Setup
library(tidyverse)
library(fgeo.biomass)
```

---

The goal is to plot dbh (x) versus biomass (y) by species ([issue](https://github.com/forestgeo/allodb/issues/73)). 

Let's first drop rows with missing `dbh` values as we can't calculate biomass for them.

```{r}
census <- fgeo.biomass::scbi_tree1 %>% 
  filter(!is.na(dbh))
```

Let's find allometric equations in allodb and calculate biomass.

```{r}
species <- fgeo.biomass::scbi_species
census_species <- census %>% 
  add_species(species, site = "SCBI")

census_equations <- allo_find(census_species)

biomass <- allo_evaluate(census_equations)
biomass
```

Now let's plot `dbh` vs. `biomass` and use the preexisting `agb` column as a coarse reference.

```{r, cache=TRUE}
census_equations_biomass <- census_equations %>% right_join(biomass)

census_equations_biomass %>% 
  # Convert agb from [Mg] to [kg]
  mutate(agb_kg = agb * 1e3) %>% 
  ggplot(aes(dbh, biomass)) + 
  # Reference based on allometries for tropical trees
  geom_point(aes(y = agb_kg), color = "grey", size = 4) +
  geom_point(aes(y = biomass)) +
  ylab("Reference `agb` (grey) and calculated biomass (black) in [kg]") +
  xlab("dbh [mm]")
```

Values over 40,000 appear to be outliers.

```{r}
census_equations_biomass %>% 
  ggplot(aes(sp, biomass)) +
  geom_hline(yintercept = 4e4, color = "red") +
  geom_boxplot() +
  ylab("biomass [kg]") +
  coord_flip()
```

Let's identify the odd `rowid`s to later exclude them. This should improve the plots. But we need to check if this equations are correct. (Remember the code doesn't yet handle height-dependent allometries; could this be the problem?)

```{r}
# Saving rowid to later exclude them
odd_rowids <- census_equations_biomass %>% 
  filter(biomass > 4e4) %>% 
  mutate(agb = agb * 1e3) %>% 
  select(rowid, sp, equation_id, biomass, agb) %>% 
  # Show the data as it is up to this point, then continue to get odd rowid
  print() %>% 
  pull(rowid) %>% 
  unique()

odd_rowids
```

Let's remove the odd `rowid`s and plot again, this time mapping each species by color.

```{r, cache=TRUE}
census_equations_biomass %>% 
  filter(!rowid %in% odd_rowids) %>% 
  # Convert agb from [Mg] to [kg]
  mutate(agb_kg = agb * 1e3) %>% 
  ggplot(aes(dbh)) + 
  # Reference based on allometries for tropical trees
  geom_point(aes(y = agb_kg), color = "grey", size = 4) +
  # Removing the legend to keep the plot simple
  geom_point(aes(y = biomass, color = sp)) +
  guides(color = "none") +
  ylab("biomass [kg]") +
  xlab("dbh [mm]")
```

We can see two groups of data-points: Those that rise above about 10,000 kg and those that don't. Let's add a horizontal reference to clearly see those groups, and let's facet the plot to identify each species.

```{r, fig.height=14}
census_equations_biomass %>% 
  filter(!rowid %in% odd_rowids) %>% 
  # Convert agb from [Mg] to [kg]
  mutate(agb_kg = agb * 1e3) %>% 
  ggplot(aes(x = dbh)) +
  geom_hline(yintercept = 1e4, color = "red") +
  geom_point(aes(y = agb_kg), size = 0.3) +
  geom_point(aes(y = biomass)) +
  facet_wrap("sp", ncol = 4) +
  ylab("Reference `agb` (grey) and calculated `biomass` (black) in [kg]") +
  xlab("dbh [mm]")
```
