---
title: "Plot dbh vs. biomass by species"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(1)
```

```{r}
# Setup
library(tidyverse)
library(fgeo.biomass)
```

---

The goal is to plot dbh (x) versus biomass (y) by species ([issue](https://github.com/forestgeo/allodb/issues/73)). 

Let's first drop rows with missing `dbh` values as we can't calculate biomass for them. For now, let's work with a sample of the entire data for a quicker exploration. The main patterns should be the same.

```{r}
census <- fgeo.biomass::scbi_tree1 %>% 
  filter(!is.na(dbh)) %>% 
  # Sample a few rows for speed
  sample_n(5000)
```

Let's find allometric equations in allodb and calculate biomass.

```{r}
species <- fgeo.biomass::scbi_species
census_species <- census %>% 
  add_species(species, site = "SCBI")

census_equations <- allo_find(census_species)

biomass <- allo_evaluate(census_equations)
biomass
```

Now let's plot `dbh` vs. `biomass`.

```{r, cache=TRUE}
census_equations_biomass <- census_equations %>% right_join(biomass)

census_equations_biomass %>% 
  ggplot(aes(dbh, biomass)) + 
  geom_point()
```

A few `biomass` values seem too high.

```{r}
census_equations_biomass %>% 
  ggplot(aes(sp, biomass)) +
  geom_boxplot() +
  coord_flip()
```

The highest `biomass` values come from a few species. Are the allometric equations for those species correct?

```{r}
descending_biomass <- census_equations_biomass %>% 
  select(sp, equation_id, eqn, dbh, biomass) %>% 
  arrange(desc(biomass))

descending_biomass %>% print(n = 30)
```

To see more detail on the lower `biomass` values, let's remove the odd species and plot again.

```{r, cache=TRUE}
odd_species <- descending_biomass %>% 
  slice(1:30) %>% 
  pull(sp) %>% 
  unique()

census_equations_biomass %>% 
  filter(!sp %in% odd_species) %>% 
  ggplot(aes(dbh, biomass)) +
  geom_point() +
  theme(legend.position = "bottom")
```

This makes more sense. 

Let's use the `agb` values that come with the data as a reference. `agb` appears to be not in [kg] but in [Ton], so we need to adjust accordingly. 

```{r}
census_equations_biomass %>% 
  filter(!sp %in% odd_species) %>% 
  ggplot(aes(x = dbh)) +
  geom_point(aes(y = agb * 1e3), color = "grey") +
  geom_point(aes(y = biomass), size = 0.3) +
  ylab(" agb [Ton] in grey and biomass [kg] in black")
```


The relationship between `dbh` and `biomass` looks quite similar to that of `dbh` and `agb`. Some difference is expected, as `agb` was apparently calculated using allometric equations for tropical species, but SCBI is in a temperate zone.

Here is a similar comparison, this time by species.

```{r, fig.height=14}
census_equations_biomass %>% 
  filter(!sp %in% odd_species) %>% 
  ggplot(aes(x = dbh)) +
  geom_point(aes(y = agb * 1e3), color = "grey") +
  geom_point(aes(y = biomass), size = 0.3) +
  facet_wrap("sp", ncol = 4)
```

