---
title: "Plot dbh vs. biomass by species"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(1)
```

```{r}
# Setup
library(tidyverse)
library(fgeo.biomass)
```

---

The goal is to plot dbh (x) versus biomass (y) by species ([issue](https://github.com/forestgeo/allodb/issues/73)). 

Let's first drop rows with missing `dbh` values as we can't calculate biomass for them.

```{r}
census <- fgeo.biomass::scbi_tree1 %>% 
  filter(!is.na(dbh))
```

Let's find allometric equations in allodb and calculate biomass.

```{r}
species <- fgeo.biomass::scbi_species
census_species <- census %>% 
  add_species(species, site = "SCBI")

census_equations <- allo_find(census_species)
```

Notice the warning that some species couldn't be matched. Later we will fall back to using generic equations but we don't support that feature yet. For now can can't calculate `biomass` for rows containing those species so we will now drop them.

```{r}
# Useless for now
census_equations %>% 
  filter(is.na(equation_id)) %>% 
  select(rowid, site, sp, equation_id)

# Dropping useless rows to continue
census_equations2 <- census_equations %>% 
  filter(!is.na(equation_id))
```

We can now calculate `biomass`.

```{r}
biomass <- allo_evaluate(census_equations2)
biomass
```

We now learn that some equations couldn't be evaluated. The problem now is that we still don't support the ability to calculate biomass from values of `dba` which results in missing `biomass` values. Let's confirm this

```{r}
census_equations_biomass <- census_equations2 %>% right_join(biomass)
census_equations_biomass %>% 
  filter(is.na(biomass)) %>% 
  select(rowid, site, sp, dbh, eqn, biomass)
```

Let's drop the corresponding rows as we can't do much with them.

```{r}
census_equations_biomass2 <- census_equations_biomass %>% filter(!is.na(biomass))
```

Now let's box plot `biomass` by species.

```{r}
census_equations_biomass2 %>% 
  ggplot(aes(sp, biomass)) +
  geom_hline(yintercept = 4e4, color = "red") +
  geom_boxplot() +
  ylab("biomass [kg]") +
  coord_flip()
```

The biomass of _Liriodendron sp._ seems relatively too high. Here is what it's equations look like.

```{r}
odd_sp <- "liriodendron tulipifera"

census_equations_biomass2 %>% 
  filter(sp == odd_sp) %>% 
  select(sp, eqn) %>% 
  unique()
```

Krista suggested that the problem may be that the code still doesn't handle dbh-specific equations ([comment](https://github.com/forestgeo/allodb/issues/73#issuecomment-473979550)). We'll implement this feature ASAP. But until then, let's exclude this species.

```{r}
census_equations_biomass3 <- census_equations_biomass2 %>% 
  filter(!sp == odd_sp)
```

Let's see what `dbh` versus `biomass` looks like now.

```{r, cache=TRUE}
census_equations_biomass3 %>% 
  # Convert agb from [Mg] to [kg]
  mutate(agb_kg = agb * 1e3) %>% 
  ggplot(aes(dbh, biomass)) + 
  # Reference based on allometries for tropical trees
  geom_point(aes(y = agb_kg), color = "grey", size = 4) +
  geom_point(aes(y = biomass)) +
  ylab("Reference `agb` (grey) and calculated biomass (black) in [kg]") +
  xlab("dbh [mm]")
```

A few points over 40000 [kg] seem relatively too high.

```{r}
census_equations_biomass3 %>% 
  filter(biomass > 4e4) %>% 
  select(sp, equation_id, eqn)
```

For a better visualization let's remove those values for now, and plot the same relationship but this time by species.

```{r, fig.height=14}
census_equations_biomass3 %>% 
  filter(!biomass > 4e4) %>% 
  # Convert agb from [Mg] to [kg]
  mutate(agb_kg = agb * 1e3) %>% 
  ggplot(aes(x = dbh)) +
  geom_point(aes(y = agb_kg), size = 1.5, color = "grey") +
  geom_point(aes(y = biomass), size = 1, color = "black") +
  facet_wrap("sp", ncol = 4) +
  ylab("Reference `agb` (grey) and calculated `biomass` (black) in [kg]") +
  xlab("dbh [mm]") +
  theme_bw()
```
