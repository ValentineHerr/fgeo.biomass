---
title: "Plot dbh vs. biomass by species"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  out.width = "90%",
  collapse = TRUE,
  comment = "#>"
)
set.seed(1)
```

```{r}
# Setup
library(tidyverse)
library(fgeo.biomass)
```

---

The goal is to plot dbh (x) versus biomass (y) by species ([issue](https://github.com/forestgeo/allodb/issues/73)). 

Let's first drop rows with missing `dbh` values as we can't calculate biomass for them.

```{r}
census <- fgeo.biomass::scbi_tree1 %>% 
  filter(!is.na(dbh))
```

Let's find allometric equations in allodb and calculate biomass.

```{r}
species <- fgeo.biomass::scbi_species
census_species <- census %>% 
  add_species(species, site = "SCBI")

census_equations <- allo_find(census_species)
```

Notice the warning that equations couldn't be found. There may be two reasons:

* Some stems in the data belong to species with no matching species in allodb.
* Some stems in the data belong to species that do match species in allodb but the available equations were designed for a dbh range that doesn't include actual dbh values in the data.

Let's drop those rows as we can't calculate `biomass` for them.

```{r}
census_equations2 <- census_equations %>% 
  filter(!is.na(eqn_id))
```

We can now calculate `biomass`.

```{r}
biomass <- allo_evaluate(census_equations2)

biomass
```

Notice the warning reminding us that we are using a tree-table (as opposed to a stem-table), and informing us about how to interpret the resulting `biomass` values for trees and shrubs.

Let's add `biomass` to the data we've been using.

```{r}
census_equations_biomass <- census_equations2 %>%
  right_join(biomass)

census_equations_biomass
```

Now let's make a box-plot of `biomass` by species.

```{r}
census_equations_biomass %>% 
  ggplot(aes(sp, biomass)) +
  geom_boxplot() +
  ylab("biomass [kg]") +
  coord_flip()
```

Let's explore `dbh` versus `biomass`.

```{r, fig.height=14}
census_equations_biomass %>% 
  # Convert agb from [Mg] to [kg]
  mutate(agb_kg = agb * 1e3) %>% 
  ggplot(aes(dbh, biomass)) + 
  # Reference based on allometries for tropical trees
  geom_point(aes(y = agb_kg), color = "grey", size = 4) +
  geom_point(aes(y = biomass, color = sp)) +
  ylab("Reference `agb` (grey) and calculated biomass (black) in [kg]") +
  xlab("dbh [mm]") +
  theme(legend.position = "bottom")
```

And now lets facet the plot by species.

```{r, fig.height=14}
census_equations_biomass %>% 
  # Convert agb from [Mg] to [kg]
  mutate(agb_kg = agb * 1e3) %>% 
  ggplot(aes(x = dbh)) +
  geom_point(aes(y = agb_kg), size = 1.5, color = "grey") +
  geom_point(aes(y = biomass), size = 1, color = "black") +
  facet_wrap("sp", ncol = 4) +
  ylab("Reference `agb` (grey) and calculated `biomass` (black) in [kg]") +
  xlab("dbh [mm]") +
  theme_bw()
```
