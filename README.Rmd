---
output: github_document 
---
<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
```

# <img src="https://i.imgur.com/vTLlhbp.png" align="right" height=88 /> Calculate biomass

[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Travis build status](https://travis-ci.org/forestgeo/fgeo.biomass.svg?branch=master)](https://travis-ci.org/forestgeo/fgeo.biomass)
[![Coverage status](https://coveralls.io/repos/github/forestgeo/fgeo.biomass/badge.svg)](https://coveralls.io/r/forestgeo/fgeo.biomass?branch=master)
[![CRAN status](https://www.r-pkg.org/badges/version/fgeo.biomass)](https://cran.r-project.org/package=fgeo.biomass)

The goal of __fgeo.biomass__ is to calculate biomass using allometric equations from the __allodb__ package. 

## Warning

This package is not ready for research. This is work in progress and you are encouraged to try this package and suggest improvements but you should not trust the results yet.

## Installation

Install the development version of **fgeo.biomass**:

```
# install.packages("devtools")
devtools::install_github("forestgeo/fgeo.biomass")
```

For details on how to install packages from GitHub, see [this article](https://goo.gl/dQKEeg).

## Example

```{r, message=FALSE}
library(tidyverse)
library(fgeo.biomass)
```

### Basics

```{r}
census <- allodb::scbi_tree1
species <- allodb::scbi_species
dbh_species <- census_species(census, species, site = "scbi")
dbh_species

equations <- get_equations(dbh_species)
equations
```

### Manipulate equations

You can use popular(tools to manipulate the nested dataframe of equations. For example:

```{r}
filter(equations, eqn_type %in% c("species", "mixed_hardwood"))
# Same
equations %>% slice(c(1, 3))

equations %>% 
  slice(c(1, 3)) %>% 
  unnest()
```

### Prioritize equations

You can prioritize available equations by setting the order in which equations of different types overwrite each other. Here is a toy example to show how this works.

* Toy data.

```{r}
toy_equations <- tibble::tribble(
  ~eqn,       ~dbh,  ~eqn_type, ~rowid, ~where,
  "dbh + 1",    10,  "species",      1, "rowid only in species",
  "dbh + 1",    10,  "species",      3, "rowid in both: lhs overwrites rhs",

  "dbh + 2",    10,  "genus",        2, "rowid only in genus",
  "dbh + 2",    10,  "genus",        3, "rowid in both: lhs overwrites rhs",
)
toy_equations

toy_nested <- nest(toy_equations, -eqn_type)
toy_nested
```

* Alternative results.

```{r}
species_overwrites_genus <- c("species", "genus")
pick_best_equations(toy_nested, order = species_overwrites_genus)

genus_overwrites_species <- c("genus", "species")
pick_best_equations(toy_nested, order = genus_overwrites_species)
```

### Calculate biomass

Calculate biomass by evaluating each allometric equations using its corresponding `dbh`.

```{r}
equations %>% 
  pick_best_equations() %>% 
  evaluate_equations()
```

### Improvements

But the function names will soon change to something like this:

```R
census %>%
  add_species(species) %>%  # instead of census_species()
  allo_find() %>%           # instead of get_equations()
  allo_customize() %>%      # new function to insert custom equations
  allo_prioritize()         # instead of pick_best_equations()
  allo_evaluate()           # instead of evaluate_equations()
```

Some other possible improvements:

* Allow using ViewFullTable and ViewTaxonomy.
* Allow using any table with the required columns.
* Simplify interfaces via generic functions that 'know' what to do with different (S3) classes of ForestGEO data -- i.e. census and species tables; ViewFullTable and ViewTaxonomy tables; or any two tables of unknown class.

### fgeo.biomass and allodb

Allometric equations come from the __allodb__ package.

```{r}
# Internal
fgeo.biomass:::.default_eqn
```

For now we are excluding some equations.

```{r}
# Internal
excluding <- fgeo.biomass:::.bad_eqn_id

allodb::equations %>% 
  filter(equation_id %in% excluding) %>% 
  select(equation_id, equation_allometry)
```

## Information

* [Getting help](SUPPORT.md).
* [Contributing](CONTRIBUTING.md).
* [Contributor Code of Conduct](CODE_OF_CONDUCT.md).
