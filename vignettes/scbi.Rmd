---
title: "Calculating biomass at SCBI"
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>"
)
set.seed(1)
```

The goal of this article is to calculate biomass using code from the [fgeo.biomass](https://forestgeo.github.io/fgeo.biomass/) package, and allometric equations from the [allodb](https://forestgeo.github.io/allodb/) package. Here I focus not on the tools but on the results. While the examples at the [home page of the fgeo.biomass package](https://forestgeo.github.io/fgeo.biomass/) show as many features as possible, this article shows a limited set of features and aims to get meaningful results. By doing so I hope to expose potential problems that I could then formally test for as I build more features.

```{r setup}
library(fgeo.biomass)
library(allodb)
```

For general purposes I will also use a few other packages including the [tidyverse](https://tidyverse.org).

```{r}
library(naniar)
library(tidyverse)
```

The data comes from the [ForestGEO plot at the Smithsonian Conservation Biology Institute (SCBI)](https://forestgeo.si.edu/sites/north-america/smithsonian-conservation-biology-institute), and is conveniently included in fgeo.biomass.

```{r}
census <- fgeo.biomass::scbi_tree1 %>% 
  # Less data for speed
  sample_n(1000)
census

species <- fgeo.biomass::scbi_species
species
```

To avoid surprises, I first quickly visualize the number of missing values.

```{r, cache=TRUE}
species %>% 
  naniar::vis_miss()
```

In `species`, the columns with missing variables play no role in biomass. So I don't worry about them.

I do the same with the `census` data.

```{r, cache=TRUE}
census %>% 
  naniar::vis_miss()
```

There are missing values in `dbh`, which is key to calculating biomass. I won't be able to calculate biomass for those rows, and they make it difficult to keep track of how many rows of useful data I have. I now drop missing `dbh` values explicitly, and continue with a cleaner `census2` dataset.

```{r, cache=TRUE}
census2 <- census %>% 
  filter(!is.na(dbh))

census2 %>% 
  nrow()

census2 %>% 
  naniar::vis_miss()
```

I can now join the census and species data, to get `dbh` and species' Latin names in the same table. The argument `site` reminds me that I need to ensure that both datasets come from the same site.

```{r}
census_species <- census2 %>% 
  add_species(species, site = "scbi")

census_species
```

The result has the same number of rows as the census data.

```{r}
identical(
  nrow(census2), 
  nrow(census_species)
)
```

If any species code in the census dataset can't be matched with a corresponding species name in the species dataset, `add_species()` rises a warning and informs which codes can't be matched and how many missing values the resulting `sp` column has.

```{r}
# Degrade the species tablel to force missmatches
species2 <- sample_frac(species, 0.5)
census2 %>% 
  add_species(species2, site = "scbi")
```

