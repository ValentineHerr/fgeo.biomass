---
title: "Plot dbh vs. biomass by species"
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(1)
```

The goal is to plot dbh (x) versus biomass (y) by species -- mapping each species to a color ([issue](https://github.com/forestgeo/allodb/issues/73)).

```{r}
library(tidyverse)
library(fgeo.biomass)
```

Let's first drop rows with missing `dbh` values as we can't calculate biomass for them.

```{r}
census <- fgeo.biomass::scbi_tree1 %>% 
  filter(!is.na(dbh)) %>% 
  # Sample a few rows for speed
  sample_n(5000)
```

This is unexpected: Some dead trees have non-missing `dbh` values. I do nothing about it and continue.

```{r}
census %>% 
  filter(status == "D") %>% 
  select(dbh, matches("status"))
```

Let's find allometric equations in allodb and calculate biomass.

```{r}
species <- fgeo.biomass::scbi_species
census_species <- census %>% 
  add_species(species, site = "SCBI")

with_equations <- allo_find(census_species)

biomass <- allo_evaluate(with_equations)
biomass
```

Let's visualize the results. First, lets plot `dbh` vs. `agb`. `agb` comes with the data; it is not what we calculated and it's maybe invalid, but it is can help have a vague idea of what to expect.

```{r}
eqn_biomass <- with_equations %>% right_join(biomass)

eqn_biomass %>% 
  ggplot(aes(dbh, agb)) + 
  geom_point()
```

Now let's plot `dbh` vs. `biomass`.

```{r, cache=TRUE}
eqn_biomass %>% 
  right_join(biomass) %>% 
  ggplot(aes(dbh, biomass)) + 
  geom_point()
```

Some values appear to be surprisingly high. 

```{r}
eqn_biomass %>% 
  right_join(biomass) %>% 
  ggplot(aes(sp, biomass)) +
  geom_boxplot() +
  coord_flip()
```

They seem to all come from the _Nyssa Sylvatica_. Is it's allometric equation correct?

```{r}
eqn_biomass %>% 
  select(sp, equation_id, eqn, dbh, biomass) %>% 
  arrange(desc(biomass))
```

To see more detail on the lower `biomass` values, let's remove that species and plot again.

```{r, cache=TRUE}
eqn_biomass %>% 
  filter(sp != "nyssa sylvatica") %>% 
  ggplot(aes(dbh, biomass, color = sp)) +
  geom_point()
```

This is more informative.

---

Some `biomass` values are missing. 

```{r}
failed <- census_species %>% 
  right_join(biomass) %>% 
  filter(is.na(biomass)) %>% 
  select(rowid, site, matches("status"), dbh, sp, biomass)

failed
```

Is this because the corresponding species couldn't be found in allodb? 

```{r}
failed_species <- unique(failed$sp)
all(failed_species %in% tolower(species$Latin))
```

No. Information for these species is available. I need to investigate what's going on.
