---
title: "Plot dbh vs. biomass by species"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

### Setup

```{r}
library(tidyverse)
library(fgeo.biomass)
```

### [Issue](https://github.com/forestgeo/allodb/issues/73)

> We'll want to make the following plot:

> * x-axis: DBH (cm)
> * y-axis: biomass (kg)
> * one colored line or series of points for each species at a site.

![](https://i.imgur.com/9yHG00Z.png)

Example: plot for SCBI. We want a plot like this except by species -- mapping each species to a color.

```{r, cache=TRUE}
p <- fgeo.biomass::scbi_tree1 %>% 
  ggplot(aes(dbh, agb, color = sp)) + 
    geom_point(size = 0.5) +
    labs(title = "SCBI allometries")

p
```


```{r, fig.height=14, cache=TRUE}
p +
  guides(color = "none") +
  facet_wrap("sp", ncol = 6)
```

### Introduction

Here I plot `dbh` vs `biomass` by species, for the species we can get a meaningful biomass right now. Some species will be left out because fgeo.biomass can't handle them until I we support some additional issues. I still don't wrap the code in an elegant function. I prefer to expose the internals to make the process more transparent during review.

I prefer to now wait and instead plot `dbh` vs. `biomass` as early as possible hoping that this will estimulate your review. Your continuous feedback is crucial in accelerating the development process.

### Data

The data comes from SCBI. ForestGEO datasets store `dbh` in [mm] but fgeo.biomass expecte [cm] (Why?). So we first convert [mm] to [cm].

```{r}
census <- fgeo.biomass::scbi_tree1 %>%  
  mutate(dbh = measurements::conv_unit(dbh, from = "mm", to = "cm"))
```

* Match data with equations from allodb and calculate biomass. Notice that we currently drop rows corresponding to species with no match in allodb for "SCBI". Soon we'll [fall back to more generic equations when species-level equations are not available](https://github.com/forestgeo/allodb/issues/72).

```{r}
species <- fgeo.biomass::scbi_species

with_equaitons <- census %>% 
  add_species(species, site = "SCBI") %>% 
  allo_find() %>% 
  allo_evaluate()
```








```{r}
with_equaitons_cm %>% 
  add_count(rowid) %>% 
  filter(n > 1) %>% 
  select(n, anatomic_relevance, equation_id, eqn, dbh, biomass)
```










In this section I pick the subset of SCBI data I can get meaninful biomass for with the code we have already implemented.



First exclude data from species for which allodb lacks equaitons (soon we'll [fall back to more generic equations when species-level equations are not available](https://github.com/forestgeo/allodb/issues/72)).

```{r}
# Find species for which allodb has equations
available_species_equations <- allodb::master() %>% 
  filter(site == "SCBI") %>% 
  pull(species) %>% 
  unique() %>% 
  tolower()

# Exclusively pick census data for which allodb has equations (drop the rest)
census1 <- census %>%
  filter(sp %in% available_species_equations)

# Compare
nrow(census)
nrow(census1)

census1
```

For now, [fgeo.biomass does not support allometric equations that are not at the level of an entire tree](https://github.com/forestgeo/allodb/issues/63).

```{r, cache=TRUE}
with_equations <- census1 %>% 
  allo_find()
```



Also, fgeo.biomass does no support equations that apply to different dbh ranges.
